<div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">Ã—</button>
  <h3 data-i18n="dialog.display_changes.title">Deploy Changes</h3>
</div>
<div class="modal-body display-changes-dialog">
  <!-- Nodes changes -->
  <% var warnings = {
    'controller': $.t('dialog.display_changes.warning_controller', {defaultValue: 'Environment will not contain the necessary number of controllers after deployment. Thus, it will not be usable.'}),
    'compute': $.t('dialog.display_changes.warning_compute', {defaultValue: 'Compute nodes are recommended for deployment.'})
  } %>
  <% var warning = null, canDeploy = true, roles = cluster.availableRoles() %>

  <% var nodesToAdd = cluster.get('nodes').where({pending_addition: true}) %>
  <% if (nodesToAdd.length) { %>
    <div class="deploy-task-name" data-i18n="dialog.display_changes.added">Added:</div>
    <% _.each(roles, function(role) { %>
      <% var count = _.filter(nodesToAdd, function(node) {return node.get('role') == role}).length %>
      <% if (count) { %>
        <div class="deploy-task-item"><%= count %> <%- $.t('dialog.display_changes.'+role, {defaultValue: role}) %> <%- $.t('dialog.display_changes.node', {defaultValue: 'node'}) %><%= count != 1 ? 's' : '' %></div>
      <% } %>
    <% }) %>
  <% } %>
  <% var nodesToDelete = cluster.get('nodes').where({pending_deletion: true}) %>
  <% if (nodesToDelete.length) { %>
    <div class="deploy-task-name" data-i18n="dialog.display_changes.deleted">Deleted:</div>
    <% _.each(roles, function(role) { %>
      <% var count = _.filter(nodesToDelete, function(node) {return node.get('role') == role}).length %>
      <% if (count) { %>
        <div class="deploy-task-item"><%= count %> <%- $.t('dialog.display_changes.'+role, {defaultValue: role}) %> <%- $.t('dialog.display_changes.node', {defaultValue: 'node'}) %><%= count != 1 ? 's' : '' %></div>
      <% } %>
    <% }) %>
  <% } %>

  <!-- Networks, OpenStack settings, nodes disks changes -->
  <% if (cluster.get('changes').length) { %>
    <div class="deploy-task-name" data-i18n="dialog.display_changes.changed">Changed:</div>
    <% var settingsChangesDescriptions = {
      'attributes': $.t('dialog.display_changes.openstack_settings', {defaultValue: 'OpenStack settings'}),
      'networks': $.t('dialog.display_changes.network_settings', {defaultValue: 'Network settings'}),
      'disks': $.t('dialog.display_changes.disks_text', {defaultValue: 'Disk configuration has been changed on following nodes:'})
    } %>
    <% var nodes = [] %>
    <% _.each(cluster.get('changes'), function(change) { %>
      <% if (_.isArray(change)) {nodes.push(_.last(change));} else { %>
        <div class="deploy-task-item"><%= settingsChangesDescriptions[change] %></div>
      <% } %>
    <% }) %>
    <% if (nodes.length) { %>
      <div class="deploy-task-item"><%= settingsChangesDescriptions.disks %></div>
      <ul>
        <% _.each(nodes, function(node) { %>
          <li><%= cluster.get('nodes').get(node).get('name') %></li>
        <% }) %>
      </ul>
    <% } %>
  <% } %>

  <hr class="slim">

  <!-- Warnings -->
  <% if (cluster.needsRedeployment()) { %>
    <div class="deploy-task-notice"><i class="icon-attention"></i> <%- $.t('dialog.display_changes.alert_text', {defaultValue: 'Some nodes have error status after deployment. Redeployment is needed.'}) %></div>
    <hr class="slim">
  <% } %>
  <%
    if (cluster.get('nodes').where({role: 'controller'}).length < size) {
      if (!cluster.get('nodes').length && !cluster.get('changes').length) canDeploy = false; else warning = 'controller';
    } else {
      _.each(roles, function(role) {
        if (warning != 'controller' && !_.filter(cluster.get('nodes').nodesAfterDeployment(), function(node) {return node.get('role') == role}).length) {
          if (role == 'controller') { warning = 'controller' }
          if (role == 'compute') { warning = 'compute' }
        }
      })
    }
  %>
  <% if (warning) { %>
    <div class="alert alert-error"><%- warnings[warning] %></div>
  <% } %>

</div>
<div class="modal-footer">
  <button class="btn" data-dismiss="modal" data-i18n="dialog.display_changes.bt_cancel">Cancel</button>
  <button class="btn btn-<%= warning ? 'danger' : 'success' %> start-deployment-btn<%= canDeploy ? '' : ' disabled' %>" data-i18n="dialog.display_changes.bt_deploy">Deploy</button>
</div>
